# U-Boot: Pine64 Quartz64 (model b)
# Maintainer: sfan5 <sfan5@live.de>

buildarch=8

pkgname=uboot-quartz64
pkgver=2024.07
pkgrel=1
pkgdesc="U-Boot for Quartz64 (B)"
arch=('aarch64')
url="https://source.denx.de/u-boot/u-boot"
license=('GPL')
install=$pkgname.install
makedepends=('bc' 'dtc' 'git' 'python' 'python-pyelftools')
_commit1=a2a0b89b6c8c612dca5ed9ed8a68db8a07f68bc0
source=("git+https://source.denx.de/u-boot/u-boot#tag=v${pkgver}"
        "https://github.com/rockchip-linux/rkbin/archive/${_commit1}.tar.gz"
        'flash_uboot.sh')
sha256sums=('SKIP'
            '9df375316869daadbf874410f4097591c32cc2dca5a30fd328ea7a1cd8f8b6a8'
            'ae9bb5c6765e3e8b9b1f4eafb095f39adf5d0915f4e179a9d48d808cd7bbdee0')

build() {
  cd u-boot

  unset CFLAGS CXXFLAGS CPPFLAGS LDFLAGS
  export ROCKCHIP_TL="../rkbin/bin/rk35/rk3566_ddr_1056MHz_v1.21.bin"
  export BL31="../rkbin/bin/rk35/rk3568_bl31_ultra_v2.17.elf"

  make quartz64-b-rk3566_defconfig
  printf '%s\n' CONFIG_ENV_IS_NOWHERE=y 'CONFIG_IDENT_STRING=" Arch Linux ARM"' >>.config

  make
  CROSS_COMPILE=aarch64-none-linux-gnu- ./make.sh
  ./tools/resource_tool --pack arch/arm/dts/rk3566-quartz64.dtb
}

package() {
  cd u-boot

  install -d "${pkgdir}"/boot
  install -t "${pkgdir}"/boot -m 0755 "${srcdir}/flash_uboot.sh"
  install -m 0644 -T u-boot-rockchip.bin "${pkgdir}"/boot/uboot.img
}
